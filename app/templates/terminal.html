{% extends 'base.html' %}
{% block page_title %}Terminal â€” {{ server.display_name }}{% endblock %}

{% block content %}
<div class="terminal-container shadow">
  <div class="terminal-header">
    <div class="terminal-title">
      <span class="terminal-dot red"></span>
      <span class="terminal-dot yellow"></span>
      <span class="terminal-dot green"></span>
      <span class="text-light ms-2">Server Terminal</span>
    </div>
    <button type="button" class="btn btn-outline-light btn-sm" onclick="window.history.back();" title="Close terminal">
      <i class="fa fa-times" aria-hidden="true"></i> Close
    </button>
  </div>
  <div id="output" class="terminal-body">
    <div id="terminal" style="height: 60vh; width: 100%;"></div>
  </div>
</div>

<!-- xterm.js and fit addon (CDN) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
<script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.7.0/lib/xterm-addon-fit.js"></script>

<script>
  const output = document.getElementById('output');
  const terminalContainer = document.getElementById('terminal');

  // WebSocket connection (SSH) - initialized after term opens
  const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';

  // Create xterm
  const term = new Terminal({cursorBlink: true, convertEol: true});
  const fitAddon = new FitAddon.FitAddon();
  term.loadAddon(fitAddon);
  term.open(terminalContainer);
  fitAddon.fit();


  const socket = new WebSocket(`${wsProtocol}//${location.host}/ssh?server={{ server.id }}`);
  socket.binaryType = 'arraybuffer';

  socket.addEventListener('open', () => {
    term.writeln('Connected to server terminal.');
    fitAddon.fit();
    socket.send(JSON.stringify({type: 'resize', cols: term.cols, rows: term.rows}));
    term.focus();
  });

  socket.addEventListener('message', (event) => {
    if (event.data === '__CLEAR__') {
      term.clear();
    } else {
      term.write(event.data);
    }
  });

  socket.addEventListener('close', () => term.writeln('\\r\\nConnection closed.'));
  socket.addEventListener('error', () => term.writeln('\\r\\nConnection error.'));

  // Send data from terminal to server
  term.onData((data) => {
    try { socket.send(data); } catch (e) { /* ignore */ }
  });

  // Resize handling
  let resizeTimeout = null;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(() => {
      fitAddon.fit();
      try { socket.send(JSON.stringify({type: 'resize', cols: term.cols, rows: term.rows})); } catch (e) { }
    }, 150);
  });

  // Paste is handled by xterm's built-in paste handling

  // Ensure focus on click
  terminalContainer.addEventListener('click', () => term.focus());
</script>
</script>

{% endblock %}
